@echo off
chcp 65001 > nul
setlocal EnableDelayedExpansion

echo ========================================
echo    ????????? ??????????? Zapret
echo ========================================
echo.

:: ????????? ????? ??????????????
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo [ADMIN] ??????????? ????? ??????????????...
    powershell -Command "Start-Process '%~f0' -Verb RunAs"
    exit /b
)

set "SCRIPT_DIR=%~dp0"
set "TRAY_BAT=!SCRIPT_DIR!start_tray.bat"
set "TASK_NAME=ZapretTrayAutoStart"

echo [INFO] ????????? ?????...
if not exist "!TRAY_BAT!" (
    echo [ERROR] ???? start_tray.bat ?? ??????!
    pause
    exit /b 1
)

if not exist "!SCRIPT_DIR!zapret_tray.py" (
    echo [ERROR] ???? zapret_tray.py ?? ??????!
    pause
    exit /b 1
)

echo [SUCCESS] ??? ????? ???????
echo [INFO] ??????? ??????? ? ???????????? ?????...

:: ??????? ?????? ??????? ???? ????
echo [CLEANUP] ??????? ?????? ???????...
schtasks /delete /tn "!TASK_NAME!" /f >nul 2>&1

:: ??????? ????? ??????? ? ?????? ?????
echo [TASK] ??????? ????? ???????...
powershell -Command "\"
$Action = New-ScheduledTaskAction -Execute 'cmd.exe' -Argument '/c \"\"!TRAY_BAT!\"\"'
$Trigger = New-ScheduledTaskTrigger -AtLogOn
$Settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)
$Principal = New-ScheduledTaskPrincipal -UserId 'SYSTEM' -LogonType ServiceAccount -RunLevel Highest
Register-ScheduledTask -TaskName '!TASK_NAME!' -Action $Action -Trigger $Trigger -Settings $Settings -Principal $Principal -Description 'Auto-start Zapret Tray GUI with admin rights' -Force
\"" >nul 2>&1

if %errorlevel% equ 0 (
    echo [SUCCESS] ??????? ??????? ? ???????????? ?????!
    
    :: ????????? ? ?????? ??? ??????????
    echo [REGISTRY] ????????? ? ????????????...
    reg add "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "ZapretTray" /t REG_SZ /d "\"!TRAY_BAT!\"" /f >nul
    
    echo.
    echo ========================================
    echo    ?????????? ????????!
    echo ========================================
    echo.
    echo ? ??????????? ?????: ZapretTrayAutoStart
    echo ? ????????????: ZapretTray
    echo ? ??????: ??? ????? ? ???????
    echo ? ?????: SYSTEM (?????????????)
    echo.
) else (
    echo [WARNING] ?? ??????? ??????? ??????? ? ????????????
    echo [INFO] ??????? ????? ??????...
    
    :: ?????? ??????
    reg add "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "ZapretTray" /t REG_SZ /d "\"!TRAY_BAT!\"" /f >nul
    if %errorlevel% equ 0 (
        echo [SUCCESS] ?????????? ???????? ????? ??????!
    ) else (
        echo [ERROR] ?? ??????? ????????? ??????????
    )
)

echo.
echo ========================================
echo    ???????? ???????
echo ========================================
echo.

echo [INFO] ????????? GUI ??? ????????...
start "" "!TRAY_BAT!"

echo.
echo [SUCCESS] ????????? ?????????!
echo [INFO] ??? ????????? ????? ? ??????? GUI ?????????? ?????????????
echo.
timeout /t 5 /nobreak >nul